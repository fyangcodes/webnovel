{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}
{{ block.super }}
<style>
    .structured-content-preview {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .content-element {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #007bff;
        background: white;
    }
    
    .content-element.text {
        border-left-color: #28a745;
    }
    
    .content-element.image {
        border-left-color: #ffc107;
    }
    
    .element-index {
        font-weight: bold;
        color: #6c757d;
    }
    
    .element-type {
        color: #007bff;
        font-weight: bold;
    }
    
    .element-content {
        margin-top: 5px;
        color: #495057;
    }
    
    .content-stats {
        display: flex;
        gap: 20px;
        margin: 10px 0;
    }
    
    .stat-item {
        background: #e9ecef;
        padding: 8px 12px;
        border-radius: 4px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 18px;
        font-weight: bold;
        color: #007bff;
    }
    
    .stat-label {
        font-size: 12px;
        color: #6c757d;
    }
    
    .task-status {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        display: none;
    }
    
    .task-status.pending {
        background: #d1ecf1;
        border-color: #bee5eb;
    }
    
    .task-status.success {
        background: #d4edda;
        border-color: #c3e6cb;
    }
    
    .task-status.failure {
        background: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .task-status.retry {
        background: #fff3cd;
        border-color: #ffeaa7;
    }
    
    .task-progress {
        margin-top: 10px;
    }
    
    .task-message {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .task-details {
        font-size: 12px;
        color: #6c757d;
    }
    
    /* Raw content field styling */
    .field-raw_content {
        background: #f8f9fa;
        border: 2px solid #007bff;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
    }
    
    .field-raw_content label {
        font-weight: bold;
        color: #007bff;
        font-size: 14px;
        margin-bottom: 10px;
        display: block;
    }
    
    .field-raw_content textarea {
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.4;
    }
    
    .field-raw_content .help {
        color: #6c757d;
        font-style: italic;
        margin-top: 5px;
        font-size: 12px;
    }
    
    .raw-content-info {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-size: 12px;
    }
    
    .raw-content-info strong {
        color: #0056b3;
    }
</style>

<script>
let currentTaskId = null;
let currentTaskType = null;
let statusCheckInterval = null;

function startTask(taskType, chapterId) {
    // Show task status area
    const statusDiv = document.getElementById('task-status');
    statusDiv.style.display = 'block';
    statusDiv.className = 'task-status pending';
    
    // Update status content
    const messageDiv = document.getElementById('task-message');
    const detailsDiv = document.getElementById('task-details');
    
    if (taskType === 'sync') {
        messageDiv.textContent = 'Starting media sync task...';
        detailsDiv.textContent = 'This will add any missing media items to the structured content.';
    } else if (taskType === 'rebuild') {
        messageDiv.textContent = 'Starting content rebuild task...';
        detailsDiv.textContent = 'This will rebuild the structured content from media order.';
    }
    
    // Make AJAX call to start the task
    const url = taskType === 'sync' 
        ? `{% url 'admin:books_chapter_sync_media' original.pk %}`
        : `{% url 'admin:books_chapter_rebuild_content' original.pk %}`;
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            setTaskId(data.task_id);
            messageDiv.textContent = data.message;
            detailsDiv.textContent = `Task ID: ${data.task_id}`;
            // Start polling for status
            startStatusPolling(taskType);
        } else {
            statusDiv.className = 'task-status failure';
            messageDiv.textContent = 'Error starting task';
            detailsDiv.textContent = data.error || 'Unknown error';
        }
    })
    .catch(error => {
        console.error('Error starting task:', error);
        statusDiv.className = 'task-status failure';
        messageDiv.textContent = 'Error starting task';
        detailsDiv.textContent = 'Network error occurred';
    });
}

function startStatusPolling(taskType) {
    currentTaskType = taskType;
    
    // Clear any existing interval
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
    
    // Check status every 2 seconds
    statusCheckInterval = setInterval(checkTaskStatus, 2000);
}

function checkTaskStatus() {
    if (!currentTaskId) {
        return;
    }
    
    fetch(`/books/task-status/?task_id=${currentTaskId}&task_type=${currentTaskType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTaskStatus(data);
                
                // Stop polling if task is complete
                if (data.is_success || data.is_failure) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                    
                    // Reload page after 3 seconds to show updated content
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                }
            } else {
                console.error('Error checking task status:', data.error);
            }
        })
        .catch(error => {
            console.error('Error checking task status:', error);
        });
}

function updateTaskStatus(data) {
    const statusDiv = document.getElementById('task-status');
    const messageDiv = document.getElementById('task-message');
    const detailsDiv = document.getElementById('task-details');
    
    // Update status class
    statusDiv.className = 'task-status';
    if (data.is_pending) {
        statusDiv.classList.add('pending');
    } else if (data.is_success) {
        statusDiv.classList.add('success');
    } else if (data.is_failure) {
        statusDiv.classList.add('failure');
    } else if (data.is_retry) {
        statusDiv.classList.add('retry');
    }
    
    // Update message
    messageDiv.textContent = data.message || 'Task in progress...';
    
    // Update details
    let details = '';
    if (data.task_id) {
        details += `Task ID: ${data.task_id}`;
    }
    if (data.added_count !== undefined) {
        details += ` | Added: ${data.added_count} media items`;
    }
    if (data.result_count !== undefined) {
        details += ` | Result: ${data.result_count} elements`;
    }
    if (data.media_count !== undefined) {
        details += ` | Media: ${data.media_count} items`;
    }
    if (data.error) {
        details += ` | Error: ${data.error}`;
    }
    
    detailsDiv.textContent = details;
}

// Store task ID when task is started (this will be set by the server response)
function setTaskId(taskId) {
    currentTaskId = taskId;
}

// Raw content field enhancements
document.addEventListener('DOMContentLoaded', function() {
    const rawContentField = document.getElementById('id_raw_content');
    if (rawContentField) {
        // Add character count display
        const charCountDiv = document.createElement('div');
        charCountDiv.className = 'raw-content-info';
        charCountDiv.innerHTML = `
            <strong>Content Statistics:</strong><br>
            Characters: <span id="char-count">0</span> | 
            Words: <span id="word-count">0</span> | 
            Lines: <span id="line-count">0</span>
        `;
        rawContentField.parentNode.appendChild(charCountDiv);
        
        // Update counts on input
        function updateCounts() {
            const content = rawContentField.value;
            const charCount = content.length;
            const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
            const lineCount = content ? content.split('\n').length : 0;
            
            document.getElementById('char-count').textContent = charCount;
            document.getElementById('word-count').textContent = wordCount;
            document.getElementById('line-count').textContent = lineCount;
        }
        
        rawContentField.addEventListener('input', updateCounts);
        updateCounts(); // Initial count
        
        // Add auto-save indicator
        let saveTimeout;
        const saveIndicator = document.createElement('div');
        saveIndicator.className = 'raw-content-info';
        saveIndicator.style.display = 'none';
        saveIndicator.innerHTML = '<strong>Auto-saving...</strong>';
        rawContentField.parentNode.appendChild(saveIndicator);
        
        rawContentField.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveIndicator.style.display = 'block';
            saveIndicator.innerHTML = '<strong>Auto-saving...</strong>';
            
            saveTimeout = setTimeout(function() {
                saveIndicator.innerHTML = '<strong>Content saved!</strong>';
                setTimeout(function() {
                    saveIndicator.style.display = 'none';
                }, 2000);
            }, 1000);
        });
    }
});
</script>
{% endblock %}

{% block field_sets %}
{{ block.super }}

{% if original.pk %}
<!-- Raw Content Information -->
<div class="module aligned">
    <h2>Raw Content System</h2>
    <div class="raw-content-info">
        <p><strong>How it works:</strong></p>
        <ul>
            <li>The <strong>Raw Content</strong> field above contains the actual text content of your chapter</li>
            <li>This content is stored in a JSON file and can be parsed into structured content</li>
            <li>When you save, the raw content is automatically saved to the JSON file</li>
            <li>If you have a paragraph style set, structured content will be auto-regenerated</li>
            <li>Use the actions below to manage structured content and media synchronization</li>
        </ul>
    </div>
</div>

<!-- Structured Content Details -->
<div class="module aligned">
    <h2>Structured Content Details</h2>
    
    <div class="content-stats">
        <div class="stat-item">
            <div class="stat-value">{{ original.get_paragraphs|length }}</div>
            <div class="stat-label">Paragraphs</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ original.images.count }}</div>
            <div class="stat-label">Images</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ original.get_structured_content|length }}</div>
            <div class="stat-label">Total Elements</div>
        </div>
    </div>
    
    <div class="structured-content-preview">
        <h4>Content Structure Preview:</h4>
        {% with structured_content=original.get_structured_content %}
            {% if structured_content %}
                {% for element in structured_content %}
                    <div class="content-element {{ element.type }}">
                        <div>
                            <span class="element-index">[{{ forloop.counter0 }}]</span>
                            <span class="element-type">{{ element.type|title }}</span>
                        </div>
                        <div class="element-content">
                            {% if element.type == 'text' %}
                                {{ element.content|truncatechars:150 }}
                            {% elif element.type == 'image' %}
                                Image ID: {{ element.image_id|default:"N/A" }}
                                {% if element.caption %}
                                    - {{ element.caption|truncatechars:100 }}
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No structured content available. Use the migration action to create structured content.</p>
            {% endif %}
        {% endwith %}
    </div>
    
    <div style="margin-top: 15px;">
        <h4>Quick Actions:</h4>
        
        <!-- Task Status Display -->
        <div id="task-status" class="task-status">
            <div id="task-message" class="task-message">Task in progress...</div>
            <div id="task-details" class="task-details">Checking status...</div>
        </div>
        
        <a href="{% url 'admin:books_chapter_regenerate_structured' original.pk %}" 
           class="button" 
           onclick="return confirm('This will regenerate the structured content from the legacy content. Continue?')">
            Regenerate Structured Content
        </a>
        <a href="{% url 'admin:books_chapter_sync_media' original.pk %}" 
           class="button" 
           onclick="startTask('sync', {{ original.pk }}); return false;">
            Sync Media with Content (Async)
        </a>
        <a href="{% url 'admin:books_chapter_rebuild_content' original.pk %}" 
           class="button" 
           onclick="startTask('rebuild', {{ original.pk }}); return false;">
            Rebuild Content from Media (Async)
        </a>
    </div>
</div>
{% endif %}
{% endblock %} 