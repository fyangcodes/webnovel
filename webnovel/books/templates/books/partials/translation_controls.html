{% load static %}

<!-- Translation Controls -->
<div class="card mt-3">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-language"></i> Translation Options
        </h5>
    </div>
    <div class="card-body">
        <!-- Available Languages for Translation -->
        {% if available_translation_languages %}
            <div class="mb-4">
                <h6 class="text-primary">
                    <i class="fas fa-plus-circle"></i> Create New Translation
                </h6>
                <p class="text-muted small mb-2">Click a language to start AI translation:</p>
                <div id="translation-buttons-container" class="d-flex flex-wrap gap-2">
                    {% for language in available_translation_languages %}
                        <button class="btn btn-outline-primary btn-sm" 
                                onclick="window.translationManager.initiateTranslation({{ chapter.id }}, {{ language.id }})">
                            <i class="fas fa-language"></i> {{ language.name }}
                        </button>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="mb-4">
                <p class="text-muted">
                    <i class="fas fa-info-circle"></i> No additional languages available for translation.
                </p>
            </div>
        {% endif %}

        <!-- All Translations Overview -->
        {% if existing_translations or chapter.original_chapter or chapter.translations.exists %}
            <div class="mb-4">
                <h6 class="text-info">
                    <i class="fas fa-list"></i> All Translations 
                    {% if existing_translations %}
                        ({{ existing_translations|length }}{% if chapter.original_chapter %}+1{% endif %})
                    {% elif chapter.original_chapter %}
                        (1)
                    {% elif chapter.translations.exists %}
                        ({{ chapter.translations.count }})
                    {% endif %}
                </h6>
                <div class="list-group">
                    <!-- Show original chapter if this is a translation -->
                    {% if chapter.original_chapter %}
                        <div class="list-group-item d-flex justify-content-between align-items-center border-primary">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center">
                                    <strong class="me-2 text-primary">
                                        <i class="fas fa-star"></i> {{ chapter.original_chapter.get_effective_language.name|default:"Original" }}
                                    </strong>
                                    <span class="badge bg-primary">Original</span>
                                </div>
                                {% if chapter.original_chapter.title and chapter.original_chapter.title != chapter.title %}
                                    <small class="text-muted d-block">{{ chapter.original_chapter.title }}</small>
                                {% endif %}
                                <small class="text-muted">
                                    Words: {{ chapter.original_chapter.word_count }} • 
                                    Book: {{ chapter.original_chapter.book.title }}
                                </small>
                            </div>
                            <div class="ms-3">
                                <a href="{% url 'books:chapter_detail' chapter.original_chapter.pk %}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> View Original
                                </a>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Show translations - use existing_translations if available, otherwise use chapter.translations.all -->
                    {% if existing_translations %}
                        {% for translation in existing_translations %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center">
                                        <strong class="me-2">{{ translation.language.name }}</strong>
                                        <span class="badge bg-{% if translation.status == 'translating' %}warning{% elif translation.status == 'draft' %}success{% elif translation.status == 'error' %}danger{% else %}secondary{% endif %}">
                                            {{ translation.get_status_display }}
                                        </span>
                                    </div>
                                    {% if translation.title and translation.title != chapter.title %}
                                        <small class="text-muted d-block">{{ translation.title }}</small>
                                    {% endif %}
                                    <small class="text-muted">
                                        Words: {{ translation.word_count }} • 
                                        Book: {{ translation.book.title }}
                                    </small>
                                </div>
                                <div class="ms-3">
                                    <a href="{% url 'books:chapter_detail' translation.pk %}" 
                                       class="btn btn-sm {% if translation.status == 'draft' %}btn-success{% else %}btn-outline-primary{% endif %}">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    {% elif chapter.translations.exists and not chapter.original_chapter %}
                        {% for translation in chapter.translations.all %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center">
                                        <strong class="me-2">{{ translation.language.name }}</strong>
                                        <span class="badge bg-{% if translation.status == 'translating' %}warning{% elif translation.status == 'draft' %}success{% elif translation.status == 'error' %}danger{% else %}secondary{% endif %}">
                                            {{ translation.get_status_display }}
                                        </span>
                                    </div>
                                    {% if translation.title and translation.title != chapter.title %}
                                        <small class="text-muted d-block">{{ translation.title }}</small>
                                    {% endif %}
                                    <small class="text-muted">
                                        Words: {{ translation.word_count }} • 
                                        Book: {{ translation.book.title }}
                                    </small>
                                </div>
                                <div class="ms-3">
                                    <a href="{% url 'books:chapter_detail' translation.pk %}" 
                                       class="btn btn-sm {% if translation.status == 'draft' %}btn-success{% else %}btn-outline-primary{% endif %}">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Quick Stats -->
        {% if existing_translations or chapter.original_chapter or chapter.translations.exists %}
            <div class="mt-3 pt-3 border-top">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="text-success">
                            <i class="fas fa-check-circle"></i>
                            <div class="small">{{ completed_translations|length }} Complete</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-warning">
                            <i class="fas fa-spinner"></i>
                            <div class="small">
                                {% if existing_translations %}
                                    {% with in_progress=existing_translations|length|add:"-"|add:completed_translations|length %}
                                        {{ in_progress }} In Progress
                                    {% endwith %}
                                {% elif chapter.translations.exists and not chapter.original_chapter %}
                                    {% with in_progress=chapter.translations.count|add:"-"|add:completed_translations|length %}
                                        {{ in_progress }} In Progress
                                    {% endwith %}
                                {% else %}
                                    0 In Progress
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-info">
                            <i class="fas fa-language"></i>
                            <div class="small">
                                {% if existing_translations %}
                                    {{ existing_translations|length }}{% if chapter.original_chapter %}+1{% endif %} Total
                                {% elif chapter.original_chapter %}
                                    1 Total
                                {% elif chapter.translations.exists %}
                                    {{ chapter.translations.count }} Total
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Translation Status Polling -->
<script>
    // Initialize translation manager if not already done
    if (typeof window.translationManager === 'undefined') {
        window.translationManager = new TranslationManager();
    }

    // Set up automatic status checking for translating chapters
    {% if existing_translations %}
        {% for translation in existing_translations %}
            {% if translation.status == 'translating' %}
                window.translationManager.pollTranslationStatus(
                    {{ chapter.id }}, 
                    3000, 
                    function(data) {
                        // Translation completed, reload page
                        location.reload();
                    },
                    function(error) {
                        console.error('Translation polling error:', error);
                    }
                );
            {% endif %}
        {% endfor %}
    {% endif %}
    
    {% if chapter.translations.exists and not chapter.original_chapter %}
        {% for translation in chapter.translations.all %}
            {% if translation.status == 'translating' %}
                window.translationManager.pollTranslationStatus(
                    {{ chapter.id }}, 
                    3000, 
                    function(data) {
                        // Translation completed, reload page
                        location.reload();
                    },
                    function(error) {
                        console.error('Translation polling error:', error);
                    }
                );
            {% endif %}
        {% endfor %}
    {% endif %}
</script> 