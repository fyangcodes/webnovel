{% extends "base.html" %}
{% load static %}

{% block title %}Translate Chapter - {{ chapter.book.title }}{% endblock %}

{% block extra_css %}
<style>
    .translation-container {
        display: flex;
        gap: 1rem;
        height: auto;
        flex-wrap: wrap;
    }
    .translation-column {
        flex: 1 1 350px;
        min-width: 320px;
        max-width: 100%;
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
    }
    @media (max-width: 900px) {
        .translation-container {
            flex-direction: column;
        }
        .translation-column {
            min-width: 0;
            width: 100%;
        }
    }
    .translation-header {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }
    .translation-content {
        flex: 1;
        overflow-x: auto;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background: #fff;
    }
    .translation-editor {
        height: 100%;
        font-family: monospace;
        resize: none;
    }
    .chapter-nav {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    .abstract-panel {
        background: #fff;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    pre {
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="chapter-nav">
        {% if previous_chapter %}
        <a href="{% url 'translations:translate_chapter' previous_chapter.id %}" class="btn btn-outline-primary">
            ← Previous Chapter
        </a>
        {% else %}
        <div></div>
        {% endif %}

        <h2 class="text-center">{{ chapter.book.title }} - Chapter {{ chapter.chapter_number }}</h2>

        {% if next_chapter %}
        <a href="{% url 'translations:translate_chapter' next_chapter.id %}" class="btn btn-outline-primary">
            Next Chapter →
        </a>
        {% else %}
        <div></div>
        {% endif %}
    </div>

    {% if chapter.abstract %}
    <div class="abstract-panel">
        <h5>Chapter Abstract</h5>
        <p>{{ chapter.abstract }}</p>
        {% if chapter.key_terms %}
        <h6>Key Terms</h6>
        <ul class="list-inline">
            {% for term in chapter.key_terms %}
            <li class="list-inline-item badge bg-info">{{ term }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endif %}

    <div class="translation-container">
        <!-- Original Text -->
        <div class="translation-column">
            <div class="translation-header">
                <h5>Original Text ({{ chapter.book.original_language }})</h5>
            </div>
            <div class="translation-content">
                <pre>{{ chapter.original_text }}</pre>
            </div>
        </div>

        {% if active_translation %}
        <!-- Selected Translation -->
        <div class="translation-column">
            <div class="translation-header">
                <h5>{{ active_lang_code|upper }} Translation</h5>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Version: {{ active_translation.version|default:"New" }}</span>
                    <a href="{% url 'translations:history' active_translation.id %}" class="btn btn-sm btn-info">
                        View History
                    </a>
                </div>
            </div>
            <div class="translation-content">
                <pre>{{ active_translation.translated_text }}</pre>
            </div>
        </div>
        {% else %}
        <!-- Prompt to select a language -->
        <div class="translation-column d-flex align-items-center justify-content-center">
            <div class="w-100 text-center">
                <h5 class="text-muted">No translation selected</h5>
                <p class="text-muted">Please select a language from the chapter list to view its translation.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                const language = this.querySelector('.translation-editor').dataset.language;
                const formData = new FormData(this);
                try {
                    const response = await fetch(`{% url 'translations:save_translation' chapter.id 'LANGCODE' %}`.replace('LANGCODE', language), {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        }
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('Translation saved successfully!');
                        const versionSpan = this.closest('.translation-column')
                            .querySelector('.translation-header span');
                        versionSpan.textContent = `Version: ${data.version}`;
                    } else {
                        alert('Error saving translation: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error saving translation. Please try again.');
                }
            });
        });
    });
</script>
{% endblock %}